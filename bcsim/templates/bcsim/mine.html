{% extends "bcsim/base.html" %}
{% load crispy_forms_tags %}

{% block title %}Mine{% endblock %}

{% block content %}

<h4 class="mb-4"><span class="text-black-50">Blokkæde [{{ blockchain.id }}]</span>: {{ blockchain.title }}</h4>      

{% if miner.creator %}
<h6>Inviter minearbejdere til blokkæden</h6>
<div class="d-flex mb-5">
    <input class="form-control" type="text" 
        value="{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.get_host }}{% url 'bcsim:home' %}?blockchain_id={{ blockchain.id }}" id="join_link" style="width:350px">
    <button class="btn btn-primary btn-sm" onclick="copy_join_link()">Kopier</button>
</div>
{% endif %}

<div class="row mb-5">
    <div class="col col-12 col-lg-6">
        {% if cur_hash %}
            {% if valid_proof %}
                <p class="alert alert-success">
                    Hash: <br>
                    <small>{{ cur_hash }}</small>
                </p>
            {% else %}
                <p class="alert alert-danger">
                    Hash: <br>
                    <small>{{ cur_hash }}</small>
                </p>
            {% endif %}
        {% endif %}
        <div class="card" >
            <div class="card-header" style="background-color: {{ miner.color}}">
                Minedrift
            </div>            
            <div class="card-body">
                <p class="pb-1 mb-1">Blok-ID: {{ block_id }}</p> 
                <p class="pb-1 mb-1">Minearbejder: {{ miner.name }}</p>
                <p class="pb-1 mb-1">Seneste hash: <small>{{ prev_hash }}</small></p>
                {% if valid_proof %}
                    <p class="pb-1 mb-1">Payload: {{ payload }} </p>
                    <p class="pb-1 mb-1">Nonce:  {{ nonce }} </p>
                {% else %}
                    <form action="{% url 'bcsim:mine' %}" method="post" id="mine_form">
                        {% csrf_token %}
                        {{ form|crispy }}
                    </form>
                {% endif %}             

                {% if valid_proof %}
                    <div class="d-flex mt-4 justify-content-between">
                        <form action="" method="POST">
                            {% csrf_token %}
                            <div class="d-flex justify-content-center">
                                <button type="submit" name="refresh" value="submit" class="btn btn-outline-danger">Kassér</button>
                            </div>
                        </form>
                        <form action="" method="POST">
                            {% csrf_token %}
                            <div class="d-flex justify-content-center mb-2">
                                <button type="submit" name="add_to_chain" value="submit" class="btn btn-outline-primary">Tilføj til blokkæde</button>
                            </div>
                        </form>
                    </div>
                {% else %}
                    <div class="d-flex justify-content-center">
                        <button type="submit" name="calculate_hash" value="submit" form="mine_form" class="btn btn-outline-primary my-2">Beregn hash</button>
                    </div>
                {% endif %}
            </div>
        </div>       
    </div> 

    <!-- Column with list of blocks in chain" -->
    <div class="col col-12 col-lg-6 mt-5 mb-3 my-lg-0" id="block-list">
        {% include 'bcsim/block_list.html' %}
    </div>

    <!-- HTMX: Update above list every every x seconds. --> 
    <div 
        hx-get="{% url 'bcsim:block_list' %}"
        hx-trigger="every 1s"
        hx-target="#block-list">
    </div>
</div> 

{% endblock %}

{% block javascript %}

<script>
    function copy_join_link() {
        // From w3schools
        var link_text = document.getElementById("join_link");
        link_text.select();
        link_text.setSelectionRange(0, link_text.value.length);
        document.execCommand("copy")
    }
</script>

{% endblock %}