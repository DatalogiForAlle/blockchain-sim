{% extends "bcsim/base.html" %}
{% load crispy_forms_tags %}

{% block title %}Minedrift{% endblock %}


{% block content %}

{% if blockchain.paused %}
    <p class="alert alert-warning">
        Minedrift er sat på pause af skaberen af denne blockchain
    </p>
{% endif %}

<h4 class="mb-4"><span class="text-black-50">Blockchain [{{ blockchain.id }}]</span>: {{ blockchain.title }}</h4>      

{% if miner.creator %}
    <form action="" method="POST">
        {% csrf_token %}
        <div class="d-flex justify-content-center">
            {% if blockchain.paused %}
                <button type="submit" name="un_pause_blockchain" value="submit" class="btn btn-secondary">
                    Genstart minedrift
                </button>
            {% else %}
                <button type="submit" name="pause_blockchain" value="submit" class="btn btn-secondary">
                    Sæt minedrift på pause
                </button>
            {% endif %}
        </div>
    </form>
{% endif %}

<p>
    <i>
    {% if blockchain.difficulty == blockchain.Level.NEM %}
        Gyldige hashes starter med 0 eller 1
    {% elif blockchain.difficulty == blockchain.Level.MEDIUM %}
        Gyldige hashes starter med 0
    {% elif blockchain.difficulty == blockchain.Level.SVÆR %}
        Gyldige hashes starter med 00
    {% endif %}
    </i>
</p>


<div class="row mb-5">
    <div class="col col-12 col-lg-6">
       
        <div class="card">
            <div class="card-header">
                Minedrift 
            </div>            
            <div class="card-body">
                <p class="pb-1 mb-1">Blok-ID: {{ block_id }}</p> 
                <p class="pb-1 mb-1">Minearbejder: <span class="px-3" style="background-color: {{ miner.color}}">{{ miner.name }}</span></p>
                <p class="pb-1 mb-1">Seneste hash: <small>{{ prev_hash }}</small></p>
                <p class="pb-1 mb-1">Payload: {{ payload }} </p>
                {% if valid_proof %}
                    <p class="pb-1 mb-1">Nonce:  {{ nonce }} </p>
                {% else %}
                    <form action="{% url 'bcsim:mine' %}" method="post" id="mine_form" novalidate>
                        {% csrf_token %}
                        {{ form|crispy }}
                    </form>
                {% endif %}             

                {% if valid_proof %}
                    <div class="d-flex mt-4 justify-content-between">
                        <form action="" method="POST">
                            {% csrf_token %}
                            <div class="d-flex justify-content-center">
                                <button type="submit" name="refresh" value="submit" class="btn btn-outline-danger">Kassér</button>
                            </div>
                        </form>
                        <form action="" method="POST">
                            {% csrf_token %}
                            <div class="d-flex justify-content-center mb-2">
                                <button type="submit" name="add_to_chain" value="submit" class="btn btn-outline-primary">Tilføj til blockchain</button>
                            </div>
                        </form>
                    </div>
                {% else %}
                    <div class="d-flex justify-content-center">
                        <button type="submit" name="calculate_hash" value="submit" form="mine_form" class="btn btn-outline-primary my-2" id="hash_btn">Beregn hash</button>
                        <button type="button" onclick = "plus_one()" class="btn btn-outline-primary my-2 ml-2" id="plus-one-button">+1</button>
                    </div>                    
                {% endif %}
            </div>
        </div>   
        {% if cur_hash %}
            {% if valid_proof %}
                <p class="alert alert-success">
                    Nonce på {{ nonce }} gav gyldigt hash: <br>
                    <small>{{ cur_hash }}</small>
                </p>
            {% else %}
                <p class="alert alert-danger">
                    Nonce på {{ nonce }} gav ugyldigt hash: <br>
                    <small>{{ cur_hash }}</small>
                </p>
            {% endif %}
        {% endif %}    
    </div> 

    <!-- Column with list of blocks in chain" -->
    <div class="col col-12 col-lg-6 mt-5 mb-3 my-lg-0" id="block-list">
        {% include 'bcsim/block_list.html' %}
    </div>

    <!-- HTMX: Update above list every every x seconds. --> 
    <div 
        hx-get="{% url 'bcsim:block_list' %}"
        hx-trigger="every 1s"
        hx-target="#block-list">
    </div>
</div> 

{% endblock %}


{% block javascript %}

<script>

    function copy_link(id) {
        var link_text = document.getElementById(id);
        link_text.select();
        link_text.setSelectionRange(0, link_text.value.length);
        document.execCommand("copy")
    }
    function plus_one(){
        nonce_input = document.getElementById("id_nonce")
        if (!nonce_input.value){
            nonce_input.value = -1;
        }
        nonce_input.value = parseInt(nonce_input.value) + 1;
        form = document.getElementById('mine_form')
        document.getElementById('hash_btn').click()
    }

    function add_eventlisteners() {
        // Disable default window scrolling on up-arrow key
        window.addEventListener("keydown", function(e) {
                if ([38].indexOf(e.keyCode) > -1) {
                    e.preventDefault();
                }
            },
            false
        ); 
        // Eventlisteners for arrow keys 
        document.addEventListener('keydown', event => {
            var elementExists = document.getElementById("id_nonce")
            if (elementExists){ 
                if (event.keyCode == 38){
                    plus_one();
                }
            }
        });
    }

    add_eventlisteners()
    
</script>

{% endblock javascript %}
